<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Data Chart</title>
    <style>
        body {
            background-color: #121212;
            color: gold;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
        }
        .form-container {
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            width: 270px;
            text-align: center;
            margin-bottom: 20px;
        }
        .form-container h1 {
            margin-bottom: 20px;
            font-size: 24px;
        }
        .form-container label {
            display: block;
            margin-bottom: 10px;
            font-size: 18px;
        }
        .form-container input, .form-container select {
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
        }
        .form-container button {
            padding: 10px 20px;
            background-color: gold;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        .chart-container {
            width: 80%;
            max-width: 800px;
            margin-top: 20px;
        }
        #stockChart {
            background-color: #1e1e1e;
            border-radius: 15px;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="form-container">
        <h1>Get Stock Data</h1>
        <form id="stockForm">
            <label for="symbol">Stock Symbol:</label>
            <input type="text" id="symbol" name="symbol" required>

            <label for="resolution">Resolution:</label>
            <select id="resolution" name="resolution" required>
                <option value="1D">1 Day</option>
                
            </select>

            <label for="startDate">Start Date:</label>
            <input type="date" id="startDate" name="startDate" required>

            <label for="startTime">Start Time:</label>
            <input type="time" id="startTime" name="startTime" required>

            <label for="endDate">End Date:</label>
            <input type="date" id="endDate" name="endDate" required>

            <label for="endTime">End Time:</label>
            <input type="time" id="endTime" name="endTime" required>

            <button type="submit">Get Data</button>
        </form>
    </div>

    <div class="chart-container">
        <canvas id="stockChart"></canvas>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        function convertResolutionToMinutes(resolution) {
            if (resolution.endsWith('H')) {
                return parseInt(resolution) * 60;
            } else if (resolution.endsWith('D')) {
                return parseInt(resolution) * 24 * 60;
            } else {
                return parseInt(resolution);
            }
        }

        document.getElementById('stockForm').addEventListener('submit', function(event) {
            event.preventDefault();

            const symbol = document.getElementById('symbol').value;
            const resolution = document.getElementById('resolution').value;
            const startDate = document.getElementById('startDate').value;
            const startTime = document.getElementById('startTime').value;
            const endDate = document.getElementById('endDate').value;
            const endTime = document.getElementById('endTime').value;

            const fromDate = new Date(`${startDate}T${startTime}`);
            const toDate = new Date(`${endDate}T${endTime}`);

            if (fromDate >= toDate) {
                alert('The "from" date must be earlier than the "to" date.');
                return;
            }

            const from = Math.floor(fromDate.getTime() / 1000);
            const to = Math.floor(toDate.getTime() / 1000);

            const totalIntervalMinutes = (to - from) / 60;
            const resolutionMinutes = convertResolutionToMinutes(resolution);
            const countback = Math.round(totalIntervalMinutes / resolutionMinutes);

            const url = `https://priceapi.moneycontrol.com/techCharts/indianMarket/stock/history?symbol=${symbol}&resolution=${resolution}&from=${from}&to=${to}&countback=${countback}&currencyCode=INR`;
            
            const headers = {
                "User-Agent": "Mozilla/5.0 (Linux; Android 11.0; Surface Duo) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/125.0.0.0 Mobile Safari/537.36"
            };

            console.log('Fetching data from URL:', url);

            fetch(url, { headers })
                .then(response => {
                    console.log('Response status:', response.status);
                    if (!response.ok) {
                        console.error('Network response was not ok', response);
                        throw new Error(`Network response was not ok: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Received data:', data);
                    if (data.s === 'no_data') {
                        alert(`No data available for the stock '${symbol}' in the given date range.`);
                    } else if (data.o && data.h && data.l && data.c && data.v && data.t) {
                        const labels = data.t.map(timestamp => new Date(timestamp * 1000).toLocaleString());
                        const openData = data.o;
                        const highData = data.h;
                        const lowData = data.l;
                        const closeData = data.c;
                        const volumeData = data.v;

                        const ctx = document.getElementById('stockChart').getContext('2d');
                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [
                                    {
                                        label: 'Open',
                                        data: openData,
                                        borderColor: 'rgba(255, 99, 132, 1)',
                                        borderWidth: 2,
                                        fill: false,
                                        pointRadius: 0
                                    },
                                    {
                                        label: 'High',
                                        data: highData,
                                        borderColor: 'rgba(54, 162, 235, 1)',
                                        borderWidth: 2,
                                        fill: false,
                                        pointRadius: 0
                                    },
                                    {
                                        label: 'Low',
                                        data: lowData,
                                        borderColor: 'rgba(255, 206, 86, 1)',
                                        borderWidth: 2,
                                        fill: false,
                                        pointRadius: 0
                                    },
                                    {
                                        label: 'Close',
                                        data: closeData,
                                        borderColor: 'rgba(75, 192, 192, 1)',
                                        borderWidth: 2,
                                        fill: false,
                                        pointRadius: 0
                                    },
                                    {
                                        label: 'Volume',
                                        data: volumeData,
                                        borderColor: 'rgba(153, 102, 255, 1)',
                                        borderWidth: 2,
                                        fill: false,
                                        yAxisID: 'y-axis-volume',
                                        pointRadius: 0
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                scales: {
                                    x: {
                                        display: true,
                                        title: {
                                            display: true,
                                            text: 'Date',
                                            color: '#ffffff'
                                        },
                                        ticks: {
                                            maxTicksLimit: 10,
                                            color: '#ffffff'
                                        },
                                        grid: {
                                            color: 'rgba(255, 255, 255, 0.2)'
                                        }
                                    },
                                    y: {
                                        display: true,
                                        title: {
                                            display: true,
                                            text: 'Price',
                                            color: '#ffffff'
                                        },
                                        ticks: {
                                            color: '#ffffff'
                                        },
                                        grid: {
                                            color: 'rgba(255, 255, 255, 0.2)'
                                        }
                                    },
                                    'y-axis-volume': {
                                        type: 'linear',
                                        display: true,
                                        position: 'right',
                                        title: {
                                            display: true,
                                            text: 'Volume',
                                            color: '#ffffff'
                                        },
                                        ticks: {
                                            color: '#ffffff'
                                        },
                                        grid: {
                                            color: 'rgba(255, 255, 255, 0.2)'
                                        }
                                    }
                                }
                            }
                        });
                    }
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    alert('Failed to fetch data. Please try again later.');
                });
        });
    </script>
</body>
</html>
